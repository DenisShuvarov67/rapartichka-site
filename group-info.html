<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ</title>
    <link rel="stylesheet" href="main.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
<!-- –ö–Ω–æ–ø–∫–∞-–±—É—Ä–≥–µ—Ä (–≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö) -->
    <button class="sidebar-toggle" id="sidebarToggleBtn" aria-label="–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é">
        <span>&#9776;</span>
    </button>

    <!-- –°–∞–π–¥–±–∞—Ä -->
<nav class="sidebar" id="sidebar">
    <a href="index.html" class="sidebar-link" title="–ì–ª–∞–≤–Ω–∞—è">
        <span class="sidebar-icon"><i class="fas fa-home"></i></span>
        <span class="sidebar-label">–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a href="attendance.html" class="sidebar-link" title="–û—Ç–º–µ—Ç–∏—Ç—å —è–≤–∫—É">
        <span class="sidebar-icon"><i class="fas fa-user-check"></i></span>
        <span class="sidebar-label">–Ø–≤–∫–∞</span>
    </a>
    <a href="absences.html" class="sidebar-link" title="–Ø–≤–∫–∞ –∑–∞ –º–µ—Å—è—Ü">
        <span class="sidebar-icon"><i class="fas fa-chart-bar"></i></span>
        <span class="sidebar-label">–Ø–≤–∫–∞ –∑–∞ –º–µ—Å—è—Ü</span>
    </a>
    <a href="students.html" class="sidebar-link" title="–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ä–æ—Å—Ç—ã –∏ –µ–≥–æ –∑–∞–º–∞">
        <span class="sidebar-icon"><i class="fas fa-user-graduate"></i></span>
        <span class="sidebar-label">–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ä–æ—Å—Ç—ã –∏ –µ–≥–æ –∑–∞–º–∞</span>
    </a>
    <a href="https://t.me/+rkj_U8Ou3uYyMzNi" class="sidebar-link" title="–ß–∞—Ç –≤ Telegram" target="_blank" rel="noopener">
        <span class="sidebar-icon"><i class="fab fa-telegram-plane"></i></span>
        <span class="sidebar-label">Telegram —á–∞—Ç</span>
    </a>
    <a id="adminLink" href="admin.html" class="sidebar-link">
        <span class="sidebar-icon"><i class="fas fa-user-shield"></i></span>
        <span class="sidebar-label">–ê–¥–º–∏–Ω<br>–ø–∞–Ω–µ–ª—å</span>
    </a>
    <a href="settings.html" class="sidebar-link" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <span class="sidebar-icon"><i class="fas fa-cog"></i></span>
        <span class="sidebar-label settings-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
    </a>
    <a href="group-info.html" class="sidebar-link active" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ">
        <span class="sidebar-icon"><i class="fas fa-users"></i></span>
        <span class="sidebar-label">–û –≥—Ä—É–ø–ø–µ</span>
    </a>
    <button class="logout-btn" id="logoutBtn">
        <span class="sidebar-icon"><i class="fas fa-sign-out-alt"></i></span>
        <span class="logout-label">–í—ã–π—Ç–∏</span>
    </button>
</nav>
    <div class="main-wrapper">
        <div class="container">
             <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–ø–ø–µ</h2>
            <p>
    <b>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:</b>
    <span id="groupName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
    <input id="groupNameInput" type="text" style="display:none;width:180px;">
    <button id="saveGroupNameBtn" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="editGroupNameBtn" style="display:none;">‚úèÔ∏è</button>
</p>
            <p><b>–ö—É—Ä–∞—Ç–æ—Ä:</b> <span id="curatorName">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <p>
              <b>–°—Ç–∞—Ä–æ—Å—Ç–∞:</b>
              <span id="headmanName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
              <input id="headmanInput" type="text" style="display:none;width:180px;">
              <button id="saveHeadmanBtn" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="editHeadmanBtn" style="display:none;">‚úèÔ∏è</button>
            </p>
            <p>
              <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</b>
              <span id="studentsCount">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
              <input id="studentsCountInput" type="number" min="1" style="display:none;width:80px;">
              <button id="saveStudentsCountBtn" style="display:none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button id="editStudentsCountBtn" style="display:none;">‚úèÔ∏è</button>
            </p>
            <h3>–°–æ—Å—Ç–∞–≤ –≥—Ä—É–ø–ø—ã</h3>
            <ul id="studentsList"></ul>
            <div style="max-width:700px;margin-bottom:32px;">
                <div>
                    <h3>–°–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø—ã –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏</h3>
                    <button id="addMemberBtn" style="margin-bottom:12px;padding:8px 18px;font-size:15px;">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
                    <table border="1" cellpadding="6" style="width:100%;border-collapse:collapse;">
    <thead>
        <tr>
            <th>–§–ò–û</th>
            <th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th>
            <th>–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å</th>
        </tr>
    </thead>
    <tbody id="groupListTable">
        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
    </tbody>
</table>
                </div>
            </div>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
    <div id="addMemberModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:24px; border-radius:8px; min-width:300px;">
            <h3>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
            <input id="memberFullName" type="text" placeholder="–§–ò–û" style="width:100%;padding:8px;margin-bottom:8px;">
            <input id="memberDuty" type="text" placeholder="–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å" style="width:100%;padding:8px;margin-bottom:8px;">
            <input id="memberBirth" type="date" placeholder="–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è" style="width:100%;padding:8px;margin-bottom:8px;">
            <div style="margin-top:12px; text-align:right;">
                <button id="saveMemberBtn" style="padding:6px 16px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="cancelMemberBtn" style="padding:6px 16px;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ -->
    <div id="editDutyModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; padding:24px; border-radius:8px; min-width:300px;">
            <h3>–ò–∑–º–µ–Ω–∏—Ç—å –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å</h3>
            <input id="editDutyInput" type="text" placeholder="–ù–æ–≤–∞—è –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å" style="width:100%;padding:8px;margin-bottom:8px;">
            <div style="margin-top:12px; text-align:right;">
                <button id="saveEditDutyBtn" style="padding:6px 16px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="cancelEditDutyBtn" style="padding:6px 16px;">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <script>
let groupMembers = [];
let editMemberIdx = null;

// --- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ ---
let currentUser = null;
try {
    currentUser = JSON.parse(localStorage.getItem('currentUser'));
} catch {}
// --- –∫–æ–Ω–µ—Ü –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ---

// --- –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –≥—Ä—É–ø–ø—ã ---
let groupName = "–ó–∞–≥—Ä—É–∑–∫–∞...";
let headmanName = "–ó–∞–≥—Ä—É–∑–∫–∞...";
let studentsCount = "–ó–∞–≥—Ä—É–∑–∫–∞...";

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
function canEditGroupInfo() {
    if (!currentUser) return false;
    const role = (currentUser.role || '').toLowerCase();
    const roleName = (currentUser.roleName || '').toLowerCase();
    return role === 'admin' || roleName === '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' || role === 'curator' || roleName === '–∫—É—Ä–∞—Ç–æ—Ä';
}

function canEditGroupName() {
    return canEditGroupInfo();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
async function fetchGroupName() {
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/group-info');
        if (res.ok) {
            const data = await res.json();
            groupName = data.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        } else {
            groupName = "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        }
    } catch {
        groupName = "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
    }
    renderGroupName();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ—Å—Ç—ã
async function fetchHeadman() {
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/headman');
        if (res.ok) {
            const data = await res.json();
            headmanName = data.headman || "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
        } else {
            headmanName = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
        }
    } catch {
        headmanName = "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω";
    }
    renderHeadman();
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
async function fetchStudentsCount() {
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/students-count');
        if (res.ok) {
            const data = await res.json();
            studentsCount = data.count || 0;
        } else {
            studentsCount = 0;
        }
    } catch {
        studentsCount = 0;
    }
    renderStudentsCount();
}

function renderGroupName() {
    document.getElementById('groupName').textContent = groupName;
    if (canEditGroupName()) {
        document.getElementById('editGroupNameBtn').style.display = '';
    } else {
        document.getElementById('editGroupNameBtn').style.display = 'none';
    }
    document.getElementById('groupName').style.display = '';
    document.getElementById('groupNameInput').style.display = 'none';
    document.getElementById('saveGroupNameBtn').style.display = 'none';
}

function renderHeadman() {
    document.getElementById('headmanName').textContent = headmanName;
    if (canEditGroupInfo()) {
        document.getElementById('editHeadmanBtn').style.display = '';
    } else {
        document.getElementById('editHeadmanBtn').style.display = 'none';
    }
    document.getElementById('headmanName').style.display = '';
    document.getElementById('headmanInput').style.display = 'none';
    document.getElementById('saveHeadmanBtn').style.display = 'none';
}

function renderStudentsCount() {
    document.getElementById('studentsCount').textContent = studentsCount;
    if (canEditGroupInfo()) {
        document.getElementById('editStudentsCountBtn').style.display = '';
    } else {
        document.getElementById('editStudentsCountBtn').style.display = 'none';
    }
    document.getElementById('studentsCount').style.display = '';
    document.getElementById('studentsCountInput').style.display = 'none';
    document.getElementById('saveStudentsCountBtn').style.display = 'none';
}

async function fetchCurator() {
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/curator');
        if (res.ok) {
            const data = await res.json();
            document.getElementById('curatorName').textContent = data.curator || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω';
        } else {
            document.getElementById('curatorName').textContent = '–û—à–∏–±–∫–∞';
        }
    } catch {
        document.getElementById('curatorName').textContent = '–û—à–∏–±–∫–∞';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    fetchGroupName();
    fetchCurator(); // <-- –¥–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –≤—ã–∑–æ–≤
    fetchGroupMembers();
    fetchHeadman();
    fetchStudentsCount();

    document.getElementById('editGroupNameBtn').onclick = function() {
        document.getElementById('groupName').style.display = 'none';
        document.getElementById('editGroupNameBtn').style.display = 'none';
        document.getElementById('groupNameInput').style.display = '';
        document.getElementById('saveGroupNameBtn').style.display = '';
        document.getElementById('groupNameInput').value = groupName;
        document.getElementById('groupNameInput').focus();
    };

    document.getElementById('saveGroupNameBtn').onclick = async function() {
        const newName = document.getElementById('groupNameInput').value.trim();
        if (!newName) return;
        try {
            const res = await fetch('https://rapartichka-site.onrender.com/group-info', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            });
            if (res.ok) {
                await fetchGroupName(); // <-- –æ–±–Ω–æ–≤–ª—è–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞!
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        } catch {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
    };

    // –°—Ç–∞—Ä–æ—Å—Ç–∞
    document.getElementById('editHeadmanBtn').onclick = function() {
        document.getElementById('headmanName').style.display = 'none';
        document.getElementById('editHeadmanBtn').style.display = 'none';
        document.getElementById('headmanInput').style.display = '';
        document.getElementById('saveHeadmanBtn').style.display = '';
        document.getElementById('headmanInput').value = headmanName;
        document.getElementById('headmanInput').focus();
    };
    document.getElementById('saveHeadmanBtn').onclick = async function() {
        const newName = document.getElementById('headmanInput').value.trim();
        if (!newName) return;
        try {
            const res = await fetch('https://rapartichka-site.onrender.com/headman', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ headman: newName })
            });
            if (res.ok) {
                await fetchHeadman();
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        } catch {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
    };

    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
    document.getElementById('editStudentsCountBtn').onclick = function() {
        document.getElementById('studentsCount').style.display = 'none';
        document.getElementById('editStudentsCountBtn').style.display = 'none';
        document.getElementById('studentsCountInput').style.display = '';
        document.getElementById('saveStudentsCountBtn').style.display = '';
        document.getElementById('studentsCountInput').value = studentsCount;
        document.getElementById('studentsCountInput').focus();
    };
    document.getElementById('saveStudentsCountBtn').onclick = async function() {
        const newCount = parseInt(document.getElementById('studentsCountInput').value, 10);
        if (!newCount || newCount < 1) return;
        try {
            const res = await fetch('https://rapartichka-site.onrender.com/students-count', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ count: newCount })
            });
            if (res.ok) {
                await fetchStudentsCount();
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        } catch {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
    };
});

// --- –û—Å—Ç–∞–ª—å–Ω–æ–π –≤–∞—à –∫–æ–¥ (—Ä–∞–±–æ—Ç–∞ —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏) ---
async function fetchGroupMembers() {
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/group-members');
        if (res.ok) {
            groupMembers = await res.json();
            console.log('groupMembers:', groupMembers);
            renderGroupList();
        } else {
            groupMembers = [];
            renderGroupList();
        }
    } catch (e) {
        groupMembers = [];
        renderGroupList();
    }
}

async function addGroupMember(member) {
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/group-members', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(member)
        });
        if (res.ok) {
            await fetchGroupMembers();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

async function deleteGroupMember(idx) {
    const member = groupMembers[idx];
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/group-members', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: member.id })
        });
        if (res.ok) {
            await fetchGroupMembers();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

async function updateGroupMember(idx, member) {
    const old = groupMembers[idx];
    try {
        const res = await fetch('https://rapartichka-site.onrender.com/group-members', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: old.id, fullName: member.fullName, duty: member.duty, birth: member.birth })
        });
        if (res.ok) {
            await fetchGroupMembers();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    }
}

function renderGroupList() {
    const tbody = document.getElementById('groupListTable');
    tbody.innerHTML = '';
    groupMembers.forEach((member, idx) => {
        let birthStr = member.birth ? member.birth : '';
        // –ï—Å–ª–∏ –µ—Å—Ç—å T, –æ–±—Ä–µ–∑–∞–µ–º –≤—Å—ë –ø–æ—Å–ª–µ T
        if (birthStr.includes('T')) {
            birthStr = birthStr.split('T')[0];
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${member.fullName || ''}</td>
            <td>${birthStr}</td>
            <td>
                ${member.duty || ''}
                <button class="edit-duty-btn" data-idx="${idx}" style="margin-left:8px;font-size:13px;">‚úèÔ∏è</button>
                <button class="delete-member-btn" data-idx="${idx}" style="margin-left:4px;font-size:13px;color:#e74c3c;">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(tr);
    });

    tbody.querySelectorAll('.edit-duty-btn').forEach(btn => {
        btn.onclick = function() {
            const idx = +btn.dataset.idx;
            openEditDutyModal(idx);
        };
    });
    tbody.querySelectorAll('.delete-member-btn').forEach(btn => {
        btn.onclick = async function() {
            const idx = +btn.dataset.idx;
            if (confirm('–£–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) {
                await deleteGroupMember(idx);
            }
        };
    });
}

document.getElementById('addMemberBtn').onclick = function() {
    document.getElementById('addMemberModal').style.display = 'flex';
    document.getElementById('memberFullName').value = '';
    document.getElementById('memberDuty').value = '';
    document.getElementById('memberBirth').value = '';
    document.getElementById('memberFullName').focus();
    editMemberIdx = null;
};

document.getElementById('saveMemberBtn').onclick = async function() {
    const fullName = document.getElementById('memberFullName').value.trim();
    const duty = document.getElementById('memberDuty').value.trim();
    const birth = document.getElementById('memberBirth').value;
    if (!fullName || !duty || !birth) return;
    if (editMemberIdx !== null) {
        await updateGroupMember(editMemberIdx, { fullName, duty, birth });
        editMemberIdx = null;
    } else {
        await addGroupMember({ fullName, duty, birth });
    }
    document.getElementById('addMemberModal').style.display = 'none';
};

function openEditDutyModal(idx) {
    editMemberIdx = idx;
    document.getElementById('editDutyInput').value = groupMembers[idx].duty;
    document.getElementById('editDutyModal').style.display = 'flex';
}

document.getElementById('saveEditDutyBtn').onclick = async function() {
    if (editMemberIdx === null) return;
    const newDuty = document.getElementById('editDutyInput').value.trim();
    if (!newDuty) return;
    await updateGroupMember(editMemberIdx, {
        fullName: groupMembers[editMemberIdx].fullName,
        duty: newDuty,
        birth: groupMembers[editMemberIdx].birth // <-- –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞–π –¥–∞—Ç—É!
    });
    document.getElementById('editDutyModal').style.display = 'none';
    editMemberIdx = null;
};

document.getElementById('cancelEditDutyBtn').onclick = function() {
    document.getElementById('editDutyModal').style.display = 'none';
    editMemberIdx = null;
};

document.addEventListener('DOMContentLoaded', fetchGroupMembers);

// –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –ø–æ –∫–Ω–æ–ø–∫–µ-–±—É—Ä–≥–µ—Ä—É
document.getElementById('sidebarToggleBtn').onclick = function(e) {
    e.stopPropagation();
    document.body.classList.toggle('sidebar-open');
    document.getElementById('sidebar').classList.toggle('open');
};

// –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–∞–π–¥–±–∞—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ (–Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
document.addEventListener('click', function(e) {
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    if (
        document.body.classList.contains('sidebar-open') &&
        !sidebar.contains(e.target) &&
        e.target !== toggleBtn
    ) {
        document.body.classList.remove('sidebar-open');
        sidebar.classList.remove('open');
    }
});
    </script>
</body>
</html>